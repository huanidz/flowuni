name: ğŸš€ Deploy Backend (Blue-Green)

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'docker/**'
      - 'commands/deploy_backend_bluegreen.sh'
      - '.github/workflows/deploy_backend_bluegreen.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ” Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸš€ Deploy Backend via Blue-Green
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "cd ~/deployment/flowuni && ./commands/deploy_backend_bluegreen.sh"
          
      - name: ğŸ©º Health Check
        run: |
          sleep 10
          curl -f https://api.flowuni.app/docs > /dev/null && echo "âœ… Backend healthy!" || (echo "âŒ Health check failed" && exit 1)