<svg viewBox="0 0 1200 800" xmlns="http://www.w3.org/2000/svg">
  <!-- Background -->
  <rect width="1200" height="800" fill="#f8fafc"/>
  
  <!-- Title -->
  <text x="600" y="30" text-anchor="middle" font-family="Arial, sans-serif" font-size="24" font-weight="bold" fill="#1e293b">
    Multi-User Flow Execution Architecture
  </text>
  
  <!-- Frontend Section -->
  <g>
    <!-- Frontend Container -->
    <rect x="50" y="80" width="300" height="350" fill="#e0f2fe" stroke="#0284c7" stroke-width="2" rx="10"/>
    <text x="200" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#0284c7">
      Frontend (React)
    </text>
    
    <!-- User 1 -->
    <rect x="70" y="120" width="120" height="80" fill="#ffffff" stroke="#0284c7" stroke-width="1" rx="5"/>
    <text x="130" y="140" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#0284c7">
      User 1
    </text>
    <text x="130" y="155" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Flow Builder
    </text>
    <text x="130" y="170" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Execution Panel
    </text>
    <text x="130" y="185" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Real-time Updates
    </text>
    
    <!-- User 2 -->
    <rect x="210" y="120" width="120" height="80" fill="#ffffff" stroke="#0284c7" stroke-width="1" rx="5"/>
    <text x="270" y="140" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#0284c7">
      User 2
    </text>
    <text x="270" y="155" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Flow Builder
    </text>
    <text x="270" y="170" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Execution Panel
    </text>
    <text x="270" y="185" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Real-time Updates
    </text>
    
    <!-- WebSocket Connections -->
    <rect x="70" y="220" width="260" height="40" fill="#dcfce7" stroke="#16a34a" stroke-width="1" rx="5"/>
    <text x="200" y="235" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#16a34a">
      WebSocket Connections
    </text>
    <text x="200" y="250" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      ws://localhost:8000/ws/{user_id}
    </text>
    
    <!-- React Hooks -->
    <rect x="70" y="280" width="260" height="60" fill="#fef3c7" stroke="#d97706" stroke-width="1" rx="5"/>
    <text x="200" y="300" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#d97706">
      React Hooks & Context
    </text>
    <text x="200" y="315" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      useFlowExecution()
    </text>
    <text x="200" y="330" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      AuthContext, ConnectionManager
    </text>
    
    <!-- REST API Calls -->
    <rect x="70" y="360" width="260" height="50" fill="#f3e8ff" stroke="#9333ea" stroke-width="1" rx="5"/>
    <text x="200" y="380" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#9333ea">
      REST API Calls
    </text>
    <text x="200" y="395" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      /api/flows/{id}/execute
    </text>
  </g>
  
  <!-- Backend Section -->
  <g>
    <!-- Backend Container -->
    <rect x="450" y="80" width="350" height="500" fill="#fef7ff" stroke="#a855f7" stroke-width="2" rx="10"/>
    <text x="625" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#a855f7">
      Backend (Python FastAPI)
    </text>
    
    <!-- WebSocket Manager -->
    <rect x="470" y="120" width="150" height="80" fill="#ffffff" stroke="#16a34a" stroke-width="1" rx="5"/>
    <text x="545" y="140" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#16a34a">
      Connection Manager
    </text>
    <text x="545" y="155" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      User Connections
    </text>
    <text x="545" y="170" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Flow Watchers
    </text>
    <text x="545" y="185" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Room Management
    </text>
    
    <!-- Flow Execution Manager -->
    <rect x="640" y="120" width="140" height="80" fill="#ffffff" stroke="#dc2626" stroke-width="1" rx="5"/>
    <text x="710" y="140" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#dc2626">
      Flow Execution
    </text>
    <text x="710" y="155" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Manager
    </text>
    <text x="710" y="170" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Node Processing
    </text>
    <text x="710" y="185" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Status Callbacks
    </text>
    
    <!-- Authentication & Authorization -->
    <rect x="470" y="220" width="310" height="50" fill="#fff1f2" stroke="#f43f5e" stroke-width="1" rx="5"/>
    <text x="625" y="240" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#f43f5e">
      Authentication & Authorization
    </text>
    <text x="625" y="255" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      User permissions, Flow ownership validation
    </text>
    
    <!-- REST API Layer -->
    <rect x="470" y="290" width="310" height="60" fill="#f0f9ff" stroke="#0ea5e9" stroke-width="1" rx="5"/>
    <text x="625" y="310" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#0ea5e9">
      REST API Layer
    </text>
    <text x="625" y="325" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      /api/flows/{id}/execute
    </text>
    <text x="625" y="340" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      /api/flows/{id}/executions
    </text>
    
    <!-- Business Logic -->
    <rect x="470" y="370" width="310" height="80" fill="#f0fdf4" stroke="#22c55e" stroke-width="1" rx="5"/>
    <text x="625" y="390" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#22c55e">
      Business Logic Layer
    </text>
    <text x="625" y="405" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Flow Definition Processing
    </text>
    <text x="625" y="420" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Node Schema Validation
    </text>
    <text x="625" y="435" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Execution Graph Building
    </text>
    
    <!-- Message Queue -->
    <rect x="470" y="470" width="150" height="60" fill="#fefbef" stroke="#f59e0b" stroke-width="1" rx="5"/>
    <text x="545" y="490" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#f59e0b">
      Message Queue
    </text>
    <text x="545" y="505" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Async Processing
    </text>
    <text x="545" y="520" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Celery/Redis
    </text>
    
    <!-- Event Broadcasting -->
    <rect x="640" y="470" width="140" height="60" fill="#f0f9ff" stroke="#3b82f6" stroke-width="1" rx="5"/>
    <text x="710" y="490" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#3b82f6">
      Event Broadcasting
    </text>
    <text x="710" y="505" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Real-time Updates
    </text>
    <text x="710" y="520" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Status Notifications
    </text>
  </g>
  
  <!-- Cache Layer -->
  <g>
    <rect x="850" y="80" width="150" height="200" fill="#fef2f2" stroke="#ef4444" stroke-width="2" rx="10"/>
    <text x="925" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#ef4444">
      Cache Layer
    </text>
    
    <!-- Redis -->
    <rect x="870" y="120" width="110" height="60" fill="#ffffff" stroke="#dc2626" stroke-width="1" rx="5"/>
    <text x="925" y="140" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#dc2626">
      Redis
    </text>
    <text x="925" y="155" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Session Storage
    </text>
    <text x="925" y="170" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Execution State
    </text>
    
    <!-- Memory Cache -->
    <rect x="870" y="200" width="110" height="60" fill="#ffffff" stroke="#dc2626" stroke-width="1" rx="5"/>
    <text x="925" y="220" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#dc2626">
      Memory Cache
    </text>
    <text x="925" y="235" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Hot Data
    </text>
    <text x="925" y="250" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      Active Connections
    </text>
  </g>
  
  <!-- Database Layer -->
  <g>
    <rect x="850" y="320" width="150" height="260" fill="#f0fdf4" stroke="#10b981" stroke-width="2" rx="10"/>
    <text x="925" y="345" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#10b981">
      Database Layer
    </text>
    
    <!-- PostgreSQL -->
    <rect x="870" y="360" width="110" height="200" fill="#ffffff" stroke="#059669" stroke-width="1" rx="5"/>
    <text x="925" y="380" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#059669">
      PostgreSQL
    </text>
    <text x="925" y="400" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      • Users
    </text>
    <text x="925" y="415" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      • Flows
    </text>
    <text x="925" y="430" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      • Flow Executions
    </text>
    <text x="925" y="445" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      • Node States
    </text>
    <text x="925" y="460" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      • Permissions
    </text>
    <text x="925" y="475" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      • Execution History
    </text>
    <text x="925" y="490" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#64748b">
      • Audit Logs
    </text>
  </g>
  
  <!-- Data Flow Arrows -->
  <!-- WebSocket connections -->
  <path d="M 350 240 L 450 240" stroke="#16a34a" stroke-width="2" fill="none" marker-end="url(#arrowgreen)"/>
  <path d="M 450 260 L 350 260" stroke="#16a34a" stroke-width="2" fill="none" marker-end="url(#arrowgreen)"/>
  <text x="400" y="235" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#16a34a">WebSocket</text>
  
  <!-- REST API -->
  <path d="M 350 320 L 450 320" stroke="#9333ea" stroke-width="2" fill="none" marker-end="url(#arrowpurple)"/>
  <text x="400" y="315" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#9333ea">REST API</text>
  
  <!-- Cache connections -->
  <path d="M 800 180 L 850 180" stroke="#ef4444" stroke-width="2" fill="none" marker-end="url(#arrowred)"/>
  <text x="825" y="175" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#ef4444">Cache</text>
  
  <!-- Database connections -->
  <path d="M 800 450 L 850 450" stroke="#10b981" stroke-width="2" fill="none" marker-end="url(#arrowgreen2)"/>
  <text x="825" y="445" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#10b981">Persist</text>
  
  <!-- Message Queue flow -->
  <path d="M 620 500 L 640 500" stroke="#f59e0b" stroke-width="2" fill="none" marker-end="url(#arrowyellow)"/>
  
  <!-- Flow Data -->
  <g>
    <rect x="50" y="620" width="950" height="120" fill="#f1f5f9" stroke="#475569" stroke-width="1" rx="10"/>
    <text x="525" y="645" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#475569">
      Data Flow Process
    </text>
    
    <!-- Process Steps -->
    <rect x="70" y="660" width="160" height="50" fill="#dbeafe" stroke="#3b82f6" stroke-width="1" rx="5"/>
    <text x="150" y="680" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#3b82f6">
      1. User Executes Flow
    </text>
    <text x="150" y="695" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#64748b">
      Frontend → Backend
    </text>
    
    <rect x="250" y="660" width="160" height="50" fill="#dcfce7" stroke="#16a34a" stroke-width="1" rx="5"/>
    <text x="330" y="680" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#16a34a">
      2. Process Nodes
    </text>
    <text x="330" y="695" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#64748b">
      Execute → Update State
    </text>
    
    <rect x="430" y="660" width="160" height="50" fill="#fef3c7" stroke="#f59e0b" stroke-width="1" rx="5"/>
    <text x="510" y="680" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#f59e0b">
      3. Broadcast Updates
    </text>
    <text x="510" y="695" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#64748b">
      WebSocket → All Clients
    </text>
    
    <rect x="610" y="660" width="160" height="50" fill="#fecaca" stroke="#ef4444" stroke-width="1" rx="5"/>
    <text x="690" y="680" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#ef4444">
      4. Cache & Persist
    </text>
    <text x="690" y="695" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#64748b">
      Redis → PostgreSQL
    </text>
    
    <rect x="790" y="660" width="160" height="50" fill="#e0e7ff" stroke="#6366f1" stroke-width="1" rx="5"/>
    <text x="870" y="680" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#6366f1">
      5. UI Updates
    </text>
    <text x="870" y="695" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#64748b">
      Real-time Visualization
    </text>
    
    <!-- Arrows between steps -->
    <path d="M 230 685 L 250 685" stroke="#64748b" stroke-width="2" fill="none" marker-end="url(#arrowgray)"/>
    <path d="M 410 685 L 430 685" stroke="#64748b" stroke-width="2" fill="none" marker-end="url(#arrowgray)"/>
    <path d="M 590 685 L 610 685" stroke="#64748b" stroke-width="2" fill="none" marker-end="url(#arrowgray)"/>
    <path d="M 770 685 L 790 685" stroke="#64748b" stroke-width="2" fill="none" marker-end="url(#arrowgray)"/>
  </g>
  
  <!-- Arrow markers -->
  <defs>
    <marker id="arrowgreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#16a34a"/>
    </marker>
    <marker id="arrowgreen2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#10b981"/>
    </marker>
    <marker id="arrowpurple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#9333ea"/>
    </marker>
    <marker id="arrowred" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#ef4444"/>
    </marker>
    <marker id="arrowyellow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f59e0b"/>
    </marker>
    <marker id="arrowgray" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
    </marker>
  </defs>
</svg>